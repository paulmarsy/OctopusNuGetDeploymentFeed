{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "name": {
            "type": "string"
        },
        "virtualMachineInstances": {
            "type": "int"
        },
        "virtualMachineSize": {
            "type": "string"
        },
        "adminUsername": {
            "type": "string"
        },
        "adminPassword": {
            "type": "securestring"
        },
        "type": {
            "type": "string",
            "allowedValues": [
                "public",
                "internal"
            ]
        },
        "virtualNetworkResourceGroupName": {
            "type": "string"
        },
        "virtualNetworkName": {
            "type": "string"
        },
        "virtualNetworkSubnetName": {
            "type": "string"
        },
        "keyVaultResourceId": {
            "type": "string"
        },
        "certificateUrl": {
            "type": "string"
        },
        "certificateThumbprint": {
            "type": "string"
        },
        "customDeployScript": {
            "type": "string"
        },
        "customAppUri": {
            "type": "string"
        }
    },
    "variables": {
        "virtualMachinePrefix": "SvcFab",
        "fabricClusterName": "[concat(parameters('name'), 'Cluster')]",
        "networkInterfaceName": "[concat(variables('virtualMachinePrefix'), 'NIC')]",
        "templateRootUri": "https://raw.githubusercontent.com/paulmarsy/OctopusNuGetDeploymentFeed/master/Azure/Templates/",
        "loadBalancerName": "[concat(parameters('name'), 'LoadBalancer')]",
        "fabricTcpGatewayPort": 19000,
        "fabricHttpGatewayPort": 19080,
        "appPort": 80,
        "networkSecurityGroupName": "[concat(parameters('name'), 'NSG')]",
        "vmNodeTypeName": "OctopusDeployNuGetFeed"
    },
    "resources": [{
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-09-01",
            "name": "common",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templateRootUri'), 'common.json')]"
                },
                "parameters": {
                    "name": {
                        "value": "[parameters('name')]"
                    },
                    "appPort": {
                        "value": "[variables('appPort')]"
                    },
                    "type": {
                        "value": "[parameters('type')]"
                    }
                }
            }
        }, {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-09-01",
            "name": "loadBalancer",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templateRootUri'), parameters('type'), 'LoadBalancer.json')]"
                },
                "parameters": {
                    "name": {
                        "value": "[parameters('name')]"
                    },
                    "virtualNetworkResourceGroupName": {
                        "value": "[parameters('virtualNetworkResourceGroupName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "virtualNetworkSubnetName": {
                        "value": "[parameters('virtualNetworkSubnetName')]"
                    },
                    "appPort": {
                        "value": "[variables('appPort')]"
                    }
                }
            }
        }, {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "name": "[variables('vmNodeTypeName')]",
            "location": "[resourceGroup().location]",
            "apiVersion": "2017-03-30",
            "sku": {
                "name": "[parameters('virtualMachineSize')]",
                "capacity": "[parameters('virtualMachineInstances')]"
            },
            "dependsOn": [
                "[concat('Microsoft.ServiceFabric/clusters/', variables('fabricClusterName'))]"
            ],
            "properties": {
                "overprovision": false,
                "upgradePolicy": {
                    "mode": "Automatic"
                },
                "virtualMachineProfile": {
                    "storageProfile": {
                        "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "2016-Datacenter-Server-Core-smalldisk",
                            "version": "latest"
                        },
                        "osDisk": {
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                                "storageAccountType": "Standard_LRS"
                            }
                        }
                    },
                    "osProfile": {
                        "computerNamePrefix": "[variables('virtualMachinePrefix')]",
                        "adminUsername": "[parameters('adminUsername')]",
                        "adminPassword": "[parameters('adminPassword')]",
                        "windowsConfiguration": {
                            "enableAutomaticUpdates": true,
                            "provisionVMAgent": true
                        },
                        "secrets": [{
                            "sourceVault": {
                                "id": "[parameters('keyVaultResourceId')]"
                            },
                            "vaultCertificates": [{
                                "certificateStore": "My",
                                "certificateUrl": "[parameters('certificateUrl')]"
                            }]
                        }]
                    },
                    "extensionProfile": {
                        "extensions": [{
                            "name": "[concat(variables('vmNodeTypeName'),'_ServiceFabricNode')]",
                            "properties": {
                                "type": "ServiceFabricNode",
                                "autoUpgradeMinorVersion": true,
                                "publisher": "Microsoft.Azure.ServiceFabric",
                                "settings": {
                                    "clusterEndpoint": "[reference(variables('fabricClusterName')).clusterEndpoint]",
                                    "nodeTypeRef": "[variables('vmNodeTypeName')]",
                                    "dataPath": "D:\\\\SvcFab",
                                    "durabilityLevel": "Bronze",
                                    "certificate": {
                                        "thumbprint": "[parameters('certificateThumbprint')]",
                                        "x509StoreName": "My"
                                    }
                                },
                                "typeHandlerVersion": "1.0"
                            }
                        },
                        {
                            "name": "[concat(variables('vmNodeTypeName'),'_VMDiagnosticsVmExt')]",     
                          "properties": {
                            "type": "IaaSDiagnostics",
                            "autoUpgradeMinorVersion": true,
                            "publisher": "AIP.Diagnostics.Test",
                            "typeHandlerVersion": "0.0",
                            "settings": {
                              "WadCfg": {
                                "SinksConfig": {
                                  "Sink": [
                                    {
                                      "name": "[concat(variables('vmNodeTypeName'), 'AppInsightsProfilerSink')]",
                                      "ApplicationInsightsProfiler": "[reference(resourceId('Microsoft.Resources/deployments','common')).outputs.appInsightsKey.value]"
                                    }
                                  ]
                                },
                                "DiagnosticMonitorConfiguration": {
                                  "overallQuotaInMB": "4096",
                                  "DiagnosticInfrastructureLogs": {
                                    "scheduledTransferLogLevelFilter": "Error"
                                  },
                                  "WindowsEventLog": {
                                    "scheduledTransferPeriod": "PT1M",
                                    "DataSource": [
                                      {
                                        "name": "Application!*[System[(Level = 1) or (Level = 2)]]"
                                      },
                                      {
                                        "name": "Security!*[System[(Level = 1 or Level = 2)]]"
                                      },
                                      {
                                        "name": "System!*[System[(Level = 1 or Level = 2)]]"
                                      }
                                    ]
                                  },
                                  "EtwProviders": {
                                    "EtwEventSourceProviderConfiguration": [
                                      {
                                        "provider": "Microsoft-ServiceFabric-Actors",
                                        "scheduledTransferKeywordFilter": "1",
                                        "scheduledTransferPeriod": "PT5M",
                                        "DefaultEvents": {
                                          "eventDestination": "ServiceFabricReliableActorEventTable"
                                        }
                                      },
                                      {
                                        "provider": "Microsoft-ServiceFabric-Services",
                                        "scheduledTransferPeriod": "PT5M",
                                        "DefaultEvents": {
                                          "eventDestination": "ServiceFabricReliableServiceEventTable"
                                        }
                                      }
                                    ],
                                    "EtwManifestProviderConfiguration": [
                                      {
                                        "provider": "cbd93bc2-71e5-4566-b3a7-595d8eeca6e8",
                                        "scheduledTransferLogLevelFilter": "Information",
                                        "scheduledTransferKeywordFilter": "4611686018427387904",
                                        "scheduledTransferPeriod": "PT5M",
                                        "DefaultEvents": {
                                          "eventDestination": "ServiceFabricSystemEventTable"
                                        }
                                      }
                                    ]
                                  }
                                }
                              }
                            }
                          }
                        }]
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [{
                            "name": "[variables('networkInterfaceName')]",
                            "properties": {
                                "primary": true,
                                "ipConfigurations": [{
                                    "name": "[concat(variables('virtualMachinePrefix'), '-IPConfig')]",
                                    "properties": {
                                        "subnet": {
                                            "id": "[reference('Microsoft.Resources/deployments/loadBalancer').outputs.subnetRef.value]"
                                        },
                                        "loadBalancerBackendAddressPools": [{
                                            "id": "[concat(resourceId(resourceGroup().name, 'Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/backendAddressPools/Backend')]"
                                        }]
                                    }
                                }]
                            },
                            "networkSecurityGroup": {
                                "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/networkSecurityGroups/', variables('networkSecurityGroupName'))]"
                            }
                        }]
                    }
                }
            }
        },
        {
            "apiVersion": "2016-09-01",
            "type": "Microsoft.ServiceFabric/clusters",
            "name": "[variables('fabricClusterName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "certificate": {
                    "thumbprint": "[parameters('certificateThumbprint')]",
                    "x509StoreName": "My"
                },
                "clientCertificateThumbprints": [{
                    "certificateThumbprint": "[parameters('certificateThumbprint')]",
                    "isAdmin": true
                }],
                "clusterState": "Default",
                "managementEndpoint": "[concat('https://',reference('Microsoft.Resources/deployments/loadBalancer').outputs.ipAddress.value,':',variables('fabricHttpGatewayPort'))]",
                "nodeTypes": [{
                    "name": "[variables('vmNodeTypeName')]",
                    "applicationPorts": {
                        "endPort": 30000,
                        "startPort": 20000
                    },
                    "clientConnectionEndpointPort": "[variables('fabricTcpGatewayPort')]",
                    "durabilityLevel": "Bronze",
                    "ephemeralPorts": {
                        "endPort": 65534,
                        "startPort": 49152
                    },
                    "httpGatewayEndpointPort": "[variables('fabricHttpGatewayPort')]",
                    "isPrimary": true,
                    "vmInstanceCount": "[parameters('virtualMachineInstances')]"
                }],
                "upgradeMode": "Automatic",
                "vmImage": "Windows",
                "fabricSettings": [{
                    "name": "KtlLogger",
                    "parameters": [{
                        "name": "SharedLogSizeInMB",
                        "value": "4096"
                    }]
                }, {
                    "parameters": [{
                        "name": "ClusterProtectionLevel",
                        "value": "EncryptAndSign"
                    }],
                    "name": "Security"
                }]
            }
        }
    ],
    "outputs": {
        "ipAddress": {
            "type": "string",
            "value": "[reference('Microsoft.Resources/deployments/loadBalancer').outputs.ipAddress.value]"
        },
        "appInsightsKey":{
            "type":"string",
            "value": "[reference('Microsoft.Resources/deployments/common').outputs.appInsightsKey.value]"
        }
    }
}