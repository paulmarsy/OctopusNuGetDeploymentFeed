{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "name": {
            "type": "string"
        },
        "virtualMachineInstances": {
            "type": "int",
            "defaultValue": 2
        },
        "virtualMachineSize": {
            "type": "string",
            "defaultValue": "Standard_A1_v2"
        },
        "adminUsername": {
            "type": "string"
        },
        "adminPassword": {
            "type": "securestring"
        },
        "type": {
            "type": "string",
            "allowedValues": [
                "public",
                "internal"
            ]
        },
        "virtualNetworkResourceGroupName": {
            "type": "string"
        },
        "virtualNetworkName": {
            "type": "string"
        },
        "virtualNetworkSubnetName": {
            "type": "string"
        },
        "customDeployScript": {
            "type": "string"
        },
        "keyVaultResourceId": {
            "type": "string"
        },
        "certificateUrl": {
            "type": "string"
        },
        "certificateThumbprint": {
            "type": "string"
        }
    },
    "variables": {
        "fabricClusterName":"[concat(parameters('name'), 'Cluster')]",
        "virtualMachinePrefix": "[parameters('name')]",
        "networkInterfaceName": "[concat(parameters('name'), '-NIC')]",
        "templateRootUri": "https://raw.githubusercontent.com/paulmarsy/OctopusNuGetDeploymentFeed/master/Azure/Templates/",
        "loadBalancerName": "[concat(parameters('name'), 'LoadBalancer')]",
        "fabricTcpGatewayPort": "19000",
        "fabricHttpGatewayPort": "19080",
        "vmNodeTypeName": "OctopusNuGetFeed"
    },
    "resources": [{
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-09-01",
            "name": "common",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templateRootUri'), 'common.json')]"
                },
                "parameters": {
                    "name": {
                        "value": "[parameters('name')]"
                    }
                }
            }
        }, {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-09-01",
            "name": "loadBalancer",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templateRootUri'), parameters('type'), 'LoadBalancer.json')]"
                },
                "parameters": {
                    "name": {
                        "value": "[parameters('name')]"
                    },
                    "virtualNetworkResourceGroupName": {
                        "value": "[parameters('virtualNetworkResourceGroupName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "virtualNetworkSubnetName": {
                        "value": "[parameters('virtualNetworkSubnetName')]"
                    }
                }
            }
        }, {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "name": "[variables('vmNodeTypeName')]",
            "location": "[resourceGroup().location]",
            "apiVersion": "2017-03-30",
            "sku": {
                "name": "[parameters('virtualMachineSize')]",
                "capacity": "[parameters('virtualMachineInstances')]"
            },
            "properties": {
                "overprovision": false,
                "upgradePolicy": {
                    "mode": "Automatic"
                },
                "virtualMachineProfile": {
                    "storageProfile": {
                        "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "2016-Datacenter-Server-Core-smalldisk",
                            "version": "latest"
                        },
                        "osDisk": {
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                                "storageAccountType": "Standard_LRS"
                            }
                        }
                    },
                    "osProfile": {
                        "computerNamePrefix": "[variables('virtualMachinePrefix')]",
                        "adminUsername": "[parameters('adminUsername')]",
                        "adminPassword": "[parameters('adminPassword')]",
                        "windowsConfiguration": {
                            "enableAutomaticUpdates": true,
                            "provisionVMAgent": true
                        },
                        "secrets": [{
                            "sourceVault": {
                                "id": "[parameters('keyVaultResourceId')]"
                            },
                            "vaultCertificates": [{
                                "certificateStore": "My",
                                "certificateUrl": "[parameters('certificateUrl')]"
                            }]
                        }]
                    },
                    "extensionProfile": {
                        "extensions": [{
                            "name": "[concat(variables('vmNodeTypeName'),'_ServiceFabricNode')]",
                            "properties": {
                                "type": "ServiceFabricNode",
                                "autoUpgradeMinorVersion": true,
                                "publisher": "Microsoft.Azure.ServiceFabric",
                                "settings": {
                                    "clusterEndpoint": "[reference(variables('fabricClusterName')).clusterEndpoint]",
                                    "nodeTypeRef": "[variables('vmNodeTypeName')]",
                                    "dataPath": "D:\\\\SvcFab",
                                    "durabilityLevel": "Bronze",
                                    "nicPrefixOverride": "10.0.0.0/24",
                                    "certificate": {
                                        "thumbprint": "[parameters('certificateThumbprint')]",
                                        "x509StoreName": "My"
                                    }
                                },
                                "typeHandlerVersion": "1.0"
                            }
                        }]
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [{
                            "name": "[variables('networkInterfaceName')]",
                            "properties": {
                                "primary": true,
                                "ipConfigurations": [{
                                    "name": "[concat(variables('virtualMachinePrefix'), '-IPConfig')]",
                                    "properties": {
                                        "subnet": {
                                            "id": "[reference('Microsoft.Resources/deployments/loadBalancer').outputs.subnetRef.value]"
                                        },
                                        "loadBalancerBackendAddressPools": [{
                                            "id": "[concat(resourceId(resourceGroup().name, 'Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/backendAddressPools/Backend')]"
                                        }],
                                        "loadBalancerInboundNatPools": [{
                                            "id": "[concat(resourceId(resourceGroup().name, 'Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/inboundNatPools/RDP')]"
                                        }]
                                    }
                                }]
                            }
                        }]
                    }
                }
            }
        },
        {
            "apiVersion": "2016-09-01",
            "type": "Microsoft.ServiceFabric/clusters",
            "name": "[variables('fabricClusterName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "certificate": {
                    "thumbprint": "[parameters('certificateThumbprint')]",
                    "x509StoreName": "My"
                },
                "clientCertificateThumbprints": [
                    {
                      "certificateThumbprint": "[parameters('certificateThumbprint')]",
                      "isAdmin": true
                    }
                  ],
                "clusterState": "Default",
                "managementEndpoint": "[concat('https://',reference('Microsoft.Resources/deployments/loadBalancer').outputs.ipAddress.value,':',variables('fabricHttpGatewayPort'))]",
                "nodeTypes": [{
                    "name": "[variables('vmNodeTypeName')]",
                    "applicationPorts": {
                        "endPort": 30000,
                        "startPort": 20000
                    },
                    "clientConnectionEndpointPort": "[variables('fabricTcpGatewayPort')]",
                    "durabilityLevel": "Bronze",
                    "ephemeralPorts": {
                        "endPort": 65534,
                        "startPort": 49152
                    },
                    "httpGatewayEndpointPort": "[variables('fabricHttpGatewayPort')]",
                    "isPrimary": true,
                    "vmInstanceCount": "[parameters('virtualMachineInstances')]"
                }],
                "upgradeMode": "Automatic",
                "vmImage": "Windows"
            }
        }
    ],
    "outputs": {
        "ipAddress": {
            "type": "string",
            "value": "[reference('Microsoft.Resources/deployments/loadBalancer').outputs.ipAddress.value]"
        }
    }
}